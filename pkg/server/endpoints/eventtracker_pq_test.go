package endpoints

import (
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
)

func TestEventTrackerPQ(t *testing.T) {
	var (
		pollInterval = 5 * time.Second
		pollFor      = 15 * time.Minute
		runFor       = pollFor + (2 * time.Minute)
	)

	clk := newFakeClock()
	eventTracker := NewEventTrackerPQ(pollInterval, pollFor, 0, clk.Now)

	var got [][]uint
	for i := uint(0); i < uint(runFor/pollInterval); i++ {
		// Add an event every poll period for the first minute
		if i < 12 {
			eventTracker.StartTracking(i + 1)
		}

		clk.Advance(pollInterval)
		selectedEvents := eventTracker.SelectEvents()
		got = append(got, selectedEvents)
		t.Logf("%s: selectedEvents: %v", clk.Elapsed(), selectedEvents)
	}

	want := [][]uint{
		{1},                                     // 5s
		{1, 2},                                  // 10s
		{1, 2, 3},                               // 15s
		{1, 2, 3, 4},                            // 20s
		{1, 2, 3, 4, 5},                         // 25s
		{1, 2, 3, 4, 5, 6},                      // 30s
		{1, 2, 3, 4, 5, 6, 7},                   // 35s
		{1, 2, 3, 4, 5, 6, 7, 8},                // 40s
		{1, 2, 3, 4, 5, 6, 7, 8, 9},             // 45s
		{1, 2, 3, 4, 5, 6, 7, 8, 9, 10},         // 50s
		{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11},     // 55s
		{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12}, // 1m0s
		{2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12},    // 1m5s
		{3, 4, 5, 6, 7, 8, 9, 10, 11, 12},       // 1m10s
		{4, 5, 6, 7, 8, 9, 10, 11, 12},          // 1m15s
		{5, 6, 7, 8, 9, 10, 11, 12},             // 1m20s
		{6, 7, 8, 9, 10, 11, 12},                // 1m25s
		{1, 7, 8, 9, 10, 11, 12},                // 1m30s
		{2, 8, 9, 10, 11, 12},                   // 1m35s
		{3, 9, 10, 11, 12},                      // 1m40s
		{4, 10, 11, 12},                         // 1m45s
		{5, 11, 12},                             // 1m50s
		{6, 12},                                 // 1m55s
		{1, 7},                                  // 2m0s
		{2, 8},                                  // 2m5s
		{3, 9},                                  // 2m10s
		{4, 10},                                 // 2m15s
		{5, 11},                                 // 2m20s
		{6, 12},                                 // 2m25s
		{1, 7},                                  // 2m30s
		{2, 8},                                  // 2m35s
		{3, 9},                                  // 2m40s
		{4, 10},                                 // 2m45s
		{5, 11},                                 // 2m50s
		{6, 12},                                 // 2m55s
		{1, 7},                                  // 3m0s
		{2, 8},                                  // 3m5s
		{3, 9},                                  // 3m10s
		{4, 10},                                 // 3m15s
		{5, 11},                                 // 3m20s
		{6, 12},                                 // 3m25s
		{1, 7},                                  // 3m30s
		{2, 8},                                  // 3m35s
		{3, 9},                                  // 3m40s
		{4, 10},                                 // 3m45s
		{5, 11},                                 // 3m50s
		{6, 12},                                 // 3m55s
		{1, 7},                                  // 4m0s
		{2, 8},                                  // 4m5s
		{3, 9},                                  // 4m10s
		{4, 10},                                 // 4m15s
		{5, 11},                                 // 4m20s
		{6, 12},                                 // 4m25s
		{1, 7},                                  // 4m30s
		{2, 8},                                  // 4m35s
		{3, 9},                                  // 4m40s
		{4, 10},                                 // 4m45s
		{5, 11},                                 // 4m50s
		{6, 12},                                 // 4m55s
		{1, 7},                                  // 5m0s
		{2, 8},                                  // 5m5s
		{3, 9},                                  // 5m10s
		{4, 10},                                 // 5m15s
		{5, 11},                                 // 5m20s
		{6, 12},                                 // 5m25s
		{1, 7},                                  // 5m30s
		{2, 8},                                  // 5m35s
		{3, 9},                                  // 5m40s
		{4, 10},                                 // 5m45s
		{5, 11},                                 // 5m50s
		{6, 12},                                 // 5m55s
		{1, 7},                                  // 6m0s
		{2, 8},                                  // 6m5s
		{3, 9},                                  // 6m10s
		{4, 10},                                 // 6m15s
		{5, 11},                                 // 6m20s
		{6, 12},                                 // 6m25s
		{1, 7},                                  // 6m30s
		{2, 8},                                  // 6m35s
		{3, 9},                                  // 6m40s
		{4, 10},                                 // 6m45s
		{5, 11},                                 // 6m50s
		{6, 12},                                 // 6m55s
		{1, 7},                                  // 7m0s
		{2, 8},                                  // 7m5s
		{3, 9},                                  // 7m10s
		{4, 10},                                 // 7m15s
		{5, 11},                                 // 7m20s
		{6, 12},                                 // 7m25s
		{1, 7},                                  // 7m30s
		{2, 8},                                  // 7m35s
		{3, 9},                                  // 7m40s
		{4, 10},                                 // 7m45s
		{5, 11},                                 // 7m50s
		{6, 12},                                 // 7m55s
		{1, 7},                                  // 8m0s
		{2, 8},                                  // 8m5s
		{3, 9},                                  // 8m10s
		{4, 10},                                 // 8m15s
		{5, 11},                                 // 8m20s
		{6, 12},                                 // 8m25s
		{1, 7},                                  // 8m30s
		{2, 8},                                  // 8m35s
		{3, 9},                                  // 8m40s
		{4, 10},                                 // 8m45s
		{5, 11},                                 // 8m50s
		{6, 12},                                 // 8m55s
		{1, 7},                                  // 9m0s
		{2, 8},                                  // 9m5s
		{3, 9},                                  // 9m10s
		{4, 10},                                 // 9m15s
		{5, 11},                                 // 9m20s
		{6, 12},                                 // 9m25s
		{1, 7},                                  // 9m30s
		{2, 8},                                  // 9m35s
		{3, 9},                                  // 9m40s
		{4, 10},                                 // 9m45s
		{5, 11},                                 // 9m50s
		{6, 12},                                 // 9m55s
		{1, 7},                                  // 10m0s
		{2, 8},                                  // 10m5s
		{3, 9},                                  // 10m10s
		{4, 10},                                 // 10m15s
		{5, 11},                                 // 10m20s
		{6, 12},                                 // 10m25s
		{7},                                     // 10m30s
		{8},                                     // 10m35s
		{9},                                     // 10m40s
		{10},                                    // 10m45s
		{11},                                    // 10m50s
		{12},                                    // 10m55s
		{1},                                     // 11m0s
		{2},                                     // 11m5s
		{3},                                     // 11m10s
		{4},                                     // 11m15s
		{5},                                     // 11m20s
		{6},                                     // 11m25s
		{7},                                     // 11m30s
		{8},                                     // 11m35s
		{9},                                     // 11m40s
		{10},                                    // 11m45s
		{11},                                    // 11m50s
		{12},                                    // 11m55s
		{1},                                     // 12m0s
		{2},                                     // 12m5s
		{3},                                     // 12m10s
		{4},                                     // 12m15s
		{5},                                     // 12m20s
		{6},                                     // 12m25s
		{7},                                     // 12m30s
		{8},                                     // 12m35s
		{9},                                     // 12m40s
		{10},                                    // 12m45s
		{11},                                    // 12m50s
		{12},                                    // 12m55s
		{1},                                     // 13m0s
		{2},                                     // 13m5s
		{3},                                     // 13m10s
		{4},                                     // 13m15s
		{5},                                     // 13m20s
		{6},                                     // 13m25s
		{7},                                     // 13m30s
		{8},                                     // 13m35s
		{9},                                     // 13m40s
		{10},                                    // 13m45s
		{11},                                    // 13m50s
		{12},                                    // 13m55s
		{1},                                     // 14m0s
		{2},                                     // 14m5s
		{3},                                     // 14m10s
		{4},                                     // 14m15s
		{5},                                     // 14m20s
		{6},                                     // 14m25s
		{7},                                     // 14m30s
		{8},                                     // 14m35s
		{9},                                     // 14m40s
		{10},                                    // 14m45s
		{11},                                    // 14m50s
		{12},                                    // 14m55s
		{1},                                     // 15m0s
		{2},                                     // 15m5s
		{3},                                     // 15m10s
		{4},                                     // 15m15s
		{5},                                     // 15m20s
		{6},                                     // 15m25s
		{7},                                     // 15m30s
		{8},                                     // 15m35s
		{9},                                     // 15m40s
		{10},                                    // 15m45s
		{11},                                    // 15m50s
		{12},                                    // 15m55s
		nil,                                     // 16m0s
		nil,                                     // 16m5s
		nil,                                     // 16m10s
		nil,                                     // 16m15s
		nil,                                     // 16m20s
		nil,                                     // 16m25s
		nil,                                     // 16m30s
		nil,                                     // 16m35s
		nil,                                     // 16m40s
		nil,                                     // 16m45s
		nil,                                     // 16m50s
		nil,                                     // 16m55s
		nil,                                     // 17m0s
	}

	assert.Equal(t, want, got)
}
